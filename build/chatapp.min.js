var app=angular.module("ChatApp",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/home.html",controller:"LoginController"}).when("/room/:roomName",{templateUrl:"templates/room.html",controller:"RoomController"}).otherwise({redirectTo:"/"})}]),app.controller("LoginController",["$scope","$location","SocketService",function(a,b,c){a.username="",a.message="";var d=io.connect("http://localhost:8080");a.connect=function(){if(d){if(""===a.username)return $(".error-msg").fadeIn(),a.message="Name can't empty",void setTimeout(function(){$(".error-msg").fadeOut()},5500);d.emit("adduser",a.username,function(e){e?(c.setConnected(d),c.setUsername(a.username),b.path("/room/lobby"),setTimeout(function(){$("#create-room").fadeIn()},500)):($(".error-msg").fadeIn(),a.message="Your name is taken, please choose another",setTimeout(function(){$(".error-msg").fadeOut()},5500)),a.$apply()})}},a.keyPress2=function(b){13===b.keyCode&&a.connect()}}]),app.controller("RoomController",["$scope","$routeParams","$location","SocketService",function(a,b,c,d){function e(a){$("#dangerMsg").fadeIn(),$("#mmsg").html(a),setTimeout(function(){$("#dangerMsg").fadeOut()},1e4)}a.roomName=b.roomName,a.currentMessage="";var f=d.getUsername();a.userName=f;var g=d.getJoinedRooms(),h=d.getSocket();console.log(g),a.rName=g,h&&(h.emit("joinroom",{room:a.roomName,pass:""},function(b,f){console.log($.inArray(a.roomName,g)),$.inArray(a.roomName,g)<0&&d.addJoinedRoom(a.roomName),"banned"===f&&(e("You are banned from "+a.roomName),c.path("/room/lobby"))}),h.on("updatechat",function(b,c){a.messages=c,a.$apply();var d=$(".chat-window")[0].scrollHeight;$(".chat-window").scrollTop(d)}),h.on("updateusers",function(b,c){b===a.roomName&&(a.users=c)}),h.emit("rooms"),h.on("roomlist",function(b){a.rooms=Object.keys(b),a.$apply()}),h.on("kicked",function(b,g){g===f&&(console.log("im out"),d.removeJoinedRoom(a.roomName),c.path("/room/lobby"),e("You have been kicked from "+a.roomName))}),h.on("banned",function(b,g){g===f&&(d.removeJoinedRoom(a.roomName),e("You have been banned from "+a.roomName),c.path("/room/lobby"))})),a.send=function(){if(h){var b=a.currentMessage.split(" ");if("/kick"===b[0]){var c=b[1];h.emit("kick",{user:c,room:a.roomName},function(b){b?(e(c+" has been kicked from "+a.roomName),console.log(c+" has been kicked")):console.log("failed to kick")})}if("/ban"===b[0]){var d=b[1];h.emit("ban",{user:d,room:a.roomName},function(a){console.log(a?d+" has been banned":"failed to ban")})}if("/unban"===b[0]){var f=b[1];h.emit("unban",{user:f,room:a.roomName},function(b){b?(e(f+" has been unbaned from "+a.roomName),console.log(f+" has been Unbanned")):console.log("failed to unban")})}else h.emit("sendmsg",{roomName:a.roomName,msg:a.currentMessage});a.currentMessage=""}},a.keyPress=function(b){13===b.keyCode&&a.send()},a.createRoom=function(){console.log("NEW ROOM"),$("#blackout").fadeIn(),$("#create-room").fadeIn(),h.emit("rooms")},a.create=function(){var a=$("#room-name").val();console.log("creat roomname "+a),$("#blackout").fadeOut(),$("#create-room").fadeOut(),h.emit("joinroom",{room:a,pass:""},function(b){b&&c.path("/room/"+a)}),h.emit("rooms")},a.menuClose=function(){console.log("close menu"),$("#create-room").fadeOut(),$("#blackout").fadeOut()},a.leaveRoom=function(){"lobby"===a.roomName?console.log("cant leave lobby"):(h.emit("partroom",a.roomName),d.removeJoinedRoom(a.roomName),c.path("/room/lobby"))},a.setActive=function(b){return a.roomName===b?"active primary":void 0}}]),app.factory("SocketService",["$http",function(){var a,b="",c=[];return{setConnected:function(b){a=b},setUsername:function(a){b=a},getUsername:function(){return b},getSocket:function(){return a},addJoinedRoom:function(a){c.push(a)},getJoinedRooms:function(){return c},removeJoinedRoom:function(a){c.splice(c.indexOf(a),1)}}}]);