var app=angular.module("ChatApp",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"templates/home.html",controller:"LoginController"}).when("/room/:roomName",{templateUrl:"templates/room.html",controller:"RoomController"}).otherwise({redirectTo:"/"})}]),app.controller("LoginController",["$scope","$location","SocketService",function(a,b,c){a.username="",a.message="";var d=io.connect("http://localhost:8080");a.connect=function(){if(d){if(""===a.username)return $(".error-msg").fadeIn(),a.message="Name can't empty",void setTimeout(function(){$(".error-msg").fadeOut()},5500);a.username=a.username.replace(/\s/g,"-");var e=a.username.charAt(0);if(-1!=e.search(/[^A-Za-z | ^0-9]/))return $(".error-msg").fadeIn(),a.message="Invalid token in name",void setTimeout(function(){$(".error-msg").fadeOut()},5500);d.emit("adduser",a.username,function(e){e?(c.setConnected(d),c.setUsername(a.username),b.path("/room/lobby"),setTimeout(function(){$("#create-room").fadeIn()},500)):($(".error-msg").fadeIn(),a.message="Your name is taken, please choose another",setTimeout(function(){$(".error-msg").fadeOut()},5500)),a.$apply()})}},a.keyPress2=function(b){13===b.keyCode&&a.connect()}}]),app.controller("RoomController",["$scope","$routeParams","$location","SocketService","RoomService","PrivateService",function(a,b,c,d,e,f){function g(a,b){"success"===b?($("#dangerMsg").removeClass(),$("#dangerMsg").addClass("alert alert-block alert-success")):"info"===b?($("#dangerMsg").removeClass(),$("#dangerMsg").addClass("alert alert-block alert-info")):"warning"===b?($("#dangerMsg").removeClass(),$("#dangerMsg").addClass("alert alert-block alert-warning")):($("#dangerMsg").removeClass(),$("#dangerMsg").addClass("alert alert-block alert-danger")),$("#dangerMsg").fadeIn(),$("#mmsg").html(a)}a.roomName=b.roomName,a.currentMessage="";var h=d.getUsername();a.userName=h;var i=0,j=!1;if(""===h)return g("Please log in to continue ","danger"),void c.path("/");var k=e.getJoinedRooms(),l=d.getSocket();a.rName=k,l&&(l.emit("joinroom",{room:a.roomName,pass:""},function(b,d){"banned"===d?(g("You are banned from "+a.roomName,"danger"),c.path("/room/lobby")):$.inArray(a.roomName,k)<0&&(e.addJoinedRoom(a.roomName),g("You joined "+a.roomName,"success"))}),l.on("updatechat",function(b,c){if(a.roomName===b){a.messages=c,a.$apply();var d=$(".chat-window")[0].scrollHeight;$(".chat-window").scrollTop(d)}}),l.on("updateusers",function(b,c,d){b===a.roomName&&(a.users=c,a.ops=d,a.$apply())}),l.on("updatetopic",function(b,c){a.topic=c}),l.emit("rooms"),l.on("roomlist",function(b){a.rooms=Object.keys(b),a.$apply()}),l.on("kicked",function(b,d){d===h?(console.log("im out"),e.removeJoinedRoom(a.roomName),c.path("/room/lobby"),g("You have been kicked from "+a.roomName,"warning")):b===a.roomName&&g(d+" has been kicked from "+a.roomName,"info")}),l.on("banned",function(b,d){d===h?(e.removeJoinedRoom(a.roomName),g("You have been banned from "+a.roomName,"danger"),c.path("/room/lobby")):b===a.roomName&&g(d+" has been banned from "+a.roomName,"info")}),l.on("opped",function(b,c){c===h&&b===a.roomName?g("You have been given the status of Operator in "+a.roomName,"success"):b===a.roomName&&g(c+" has been made op in","info")}),l.on("deopped",function(b,c){c===h&&b===a.roomName?g("You have been removed as Operator in "+a.roomName,"success"):b===a.roomName&&g(c+" has been  deopped","info")}),l.on("recv_privatemsg",function(b,c){console.log("RECV"),console.log("sec "+c);var d={};d.sender=b,d.nick=a.userName,d.message=c,f.addPm(d),a.showPm();var e=$(".pm-window")[0].scrollHeight;$(".pm-window").scrollTop(e),g("Private message recived from <strong>"+b+"</strong>","info"),a.currentMessage="/pm "+b+" ",$("#appendedInputButton").focus()})),a.send=function(){if(l){if(""===a.currentMessage)return void $("#appendedInputButton").focus();if(i+=1,delay=20,j===!1&&setTimeout(function(){j===!1&&(i=0)},1e4),i>5)return $(".skamm").prop("disabled",!0),j=!0,g("Play nice! dont't be spammin' You're muted for 25 sec.","danger"),void setTimeout(function(){i=0,g("You play now, but play nice!","info"),$(".skamm").prop("disabled",!1),j=!1},25e3);var b=a.currentMessage.split(" ");if("/kick"===b[0]){var c=b[1];l.emit("kick",{user:c,room:a.roomName},function(b){b?(g(c+" has been kicked from "+a.roomName,"info"),console.log(c+" has been kicked")):(console.log("failed to kick"),g("Failed to kick are you op ?","warning"))})}else if("/ban"===b[0]){var d=b[1];l.emit("ban",{user:d,room:a.roomName},function(b){b?(console.log(d+" has been banned"),g(d+" has been banned from "+a.roomName,"success")):(console.log("failed to ban"),g("Failed to ban are you op ? or is user banned ?","warning"))})}else if("/unban"===b[0]){var e=b[1];l.emit("unban",{user:e,room:a.roomName},function(b){b?(g(e+" has been unbaned from "+a.roomName,"success"),console.log(e+" has been Unbanned")):(console.log("failed to unban"),g("failed to unban are you op ? or is user banned ?","warning"))})}else if("/settopic"===b[0]){b.shift();var h=b.join(" ");l.emit("settopic",{topic:h,room:a.roomName},function(a){a?g("Topic successfully changed...","success"):g("Can't change topic, are you op ?","warning")})}else if("/op"===b[0]){var k=b[1];l.emit("op",{user:k,room:a.roomName},function(a){a?g(k+" has been made op","success"):(g("Failed to make op","warning"),console.log("Failed to make a new admin"))})}else if("/deop"===b[0]){var m=b[1];l.emit("deop",{user:m,room:a.roomName},function(a){a?(console.log("admin removed"),g(m+" has been deoped","success")):(console.log("Failed to remove admin"),g("Failed to deop","warning"))})}else if("/pm"==b[0]){var n={};n.sender=a.userName,n.nick=b[1],b.shift(),b.shift();var o=b.join(" ");if(""===o)return a.currentMessage="/pm "+n.nick+" ",void $("#appendedInputButton").focus();n.message=o,l.emit("privatemsg",n,function(b){b&&(console.log("SENTPM"),g("Private message sent to <strong>"+n.nick+"</strong>","success"),f.addPm(n),a.showPm())})}else l.emit("sendmsg",{roomName:a.roomName,msg:a.currentMessage});a.currentMessage=""}},a.keyPress=function(b){13===b.keyCode?a.send():27===b.keyCode&&(a.currentMessage="")},a.createRoom=function(){a.closePrvt(),$("#blackout").fadeIn(),$("#create-room").fadeIn(),l.emit("rooms")},a.helpBox=function(){a.closePrvt(),$("#blackout").fadeIn(),$("#help").fadeIn()},a.create=function(){var a=$("#room-name").val();if(console.log("creat roomname "+a),$("#blackout").fadeOut(),$("#create-room").fadeOut(),a.length>10)return void g("Room name too long","danger");a=a.replace(/\s/g,"-");var b=a.charAt(0);return-1!=b.search(/[^A-Za-z | ^0-9]/)?void g("Invalid token in room name ","danger"):(l.emit("joinroom",{room:a,pass:""},function(b){b&&c.path("/room/"+a)}),void l.emit("rooms"))},a.menuClose=function(){$("#create-room").fadeOut(),$("#blackout").fadeOut()},a.helpClose=function(){$("#help").fadeOut(),$("#blackout").fadeOut()},a.leaveRoom=function(){"lobby"===a.roomName?g("Cant Leave lobby","info"):(l.emit("partroom",a.roomName),e.removeJoinedRoom(a.roomName),g("You left "+a.roomName,"info"),c.path("/room/lobby"))},a.setActive=function(b){return a.roomName===b?($(".close-room").hide(),"lobby"!==b&&$("#"+b).next(".close-room").show(),"active"):void 0},a.disconnect=function(){l.emit("logout"),g("You have been disconnected...Hope to see you soon..","success"),setTimeout(function(){$("#blackout").fadeIn(),$("#dangerMsg").fadeOut()},2e3),c.path("/")},a.showPm=function(){a.pms=f.getPmHistory(),a.$$phase||a.$apply(),$(".private-message").is(":visible")===!1&&$(".private-message").fadeIn()},a.pm=function(b){return b===a.userName?void g("Why would you want to talk to your self ?","info"):(a.currentMessage="/pm "+b+" ",void $("#appendedInputButton").focus())},a.closePrvt=function(){$(".private-message").is(":visible")===!0&&$(".private-message").hide()}}]),app.factory("PrivateService",["$http",function(){var a=[];return{addPm:function(b){a.push(b)},getPmHistory:function(){return a}}}]),app.factory("RoomService",["$http",function(){var a=[];return{addJoinedRoom:function(b){a.push(b)},getJoinedRooms:function(){return a},removeJoinedRoom:function(b){a.splice(a.indexOf(b),1)}}}]),app.factory("SocketService",["$http",function(){var a,b="";return{setConnected:function(b){a=b},setUsername:function(a){b=a},getUsername:function(){return b},getSocket:function(){return a}}}]);